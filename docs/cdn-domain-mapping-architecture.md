# CDN域名映射技术架构图解

## 概述

本文档通过架构图和流程图详细说明CDN中访问域名与回源域名分离的技术实现原理。

## 1. 整体架构图

```
┌─────────────────┐    DNS解析     ┌─────────────────┐    智能路由    ┌─────────────────┐
│                 │ ──────────────> │                 │ ──────────────> │                 │
│   用户浏览器     │                │  CloudFront DNS │                │   边缘节点       │
│                 │ <────────────── │                 │ <────────────── │                 │
└─────────────────┘    返回IP       └─────────────────┘    返回IP      └─────────────────┘
         │                                                                       │
         │ HTTPS请求                                                             │
         │ Host: oms-daily.palmpaybd.com                                        │
         v                                                                       │
┌─────────────────┐                                                             │
│                 │                                                             │
│  CDN域名访问     │                                                             │
│ oms-daily.      │                                                             │
│ palmpaybd.com   │                                                             │
│                 │                                                             │
└─────────────────┘                                                             │
                                                                                │
                                    ┌─────────────────────────────────────────┘
                                    │
                                    v
                          ┌─────────────────┐    Host头转换    ┌─────────────────┐
                          │                 │ ──────────────> │                 │
                          │   请求处理       │                │   回源请求       │
                          │                 │                │                 │
                          │ • 缓存查找       │                │ Host: oms-daily. │
                          │ • 策略应用       │                │ palmpay-inc.com │
                          │ • 域名映射       │                │                 │
                          └─────────────────┘                └─────────────────┘
                                                                       │
                                                                       │ HTTPS请求
                                                                       v
                                                             ┌─────────────────┐
                                                             │                 │
                                                             │   源站服务器     │
                                                             │ oms-daily.      │
                                                             │ palmpay-inc.com │
                                                             │                 │
                                                             └─────────────────┘
```

## 2. DNS解析流程图

```
用户输入: https://oms-daily.palmpaybd.com/api/users
                    │
                    v
            ┌───────────────┐
            │   本地DNS      │
            │   查询缓存     │
            └───────┬───────┘
                    │ 缓存未命中
                    v
            ┌───────────────┐
            │   递归DNS      │
            │   服务器       │
            └───────┬───────┘
                    │
                    v
            ┌───────────────┐
            │ CloudFront     │
            │ 权威DNS服务器   │
            └───────┬───────┘
                    │
                    v
            ┌───────────────┐
            │   地理位置     │
            │   智能计算     │
            └───────┬───────┘
                    │
                    v
            ┌───────────────┐
            │   返回最近     │
            │   边缘节点IP   │
            └───────────────┘
                    │
                    v
        返回: d1zwknaxg525fq.cloudfront.net
              IP: 13.227.74.68, 13.227.74.76
```

## 3. 请求处理流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            CloudFront 边缘节点                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  1. 接收用户请求                                                             │
│  ┌─────────────────┐                                                        │
│  │ GET /api/users  │                                                        │
│  │ Host: oms-daily.│                                                        │
│  │ palmpaybd.com   │                                                        │
│  └─────────────────┘                                                        │
│           │                                                                 │
│           v                                                                 │
│  2. 缓存查找                                                                 │
│  ┌─────────────────┐     命中      ┌─────────────────┐                      │
│  │   生成缓存键     │ ──────────────> │   返回缓存内容   │                      │
│  │                 │               │                 │                      │
│  │ dist:E2N6RIQ... │               │   (结束流程)     │                      │
│  │ domain:oms-...  │               │                 │                      │
│  │ path:/api/users │               └─────────────────┘                      │
│  └─────────────────┘                                                        │
│           │                                                                 │
│           │ 缓存未命中                                                        │
│           v                                                                 │
│  3. 域名映射与Host头转换                                                      │
│  ┌─────────────────┐                                                        │
│  │ 查找分配配置     │                                                        │
│  │                 │                                                        │
│  │ CDN域名:        │                                                        │
│  │ oms-daily.      │                                                        │
│  │ palmpaybd.com   │                                                        │
│  │                 │                                                        │
│  │ 映射到源站:      │                                                        │
│  │ oms-daily.      │                                                        │
│  │ palmpay-inc.com │                                                        │
│  └─────────────────┘                                                        │
│           │                                                                 │
│           v                                                                 │
│  4. 构建回源请求                                                             │
│  ┌─────────────────┐                                                        │
│  │ GET /api/users  │                                                        │
│  │ Host: oms-daily.│  ← Host头已转换                                         │
│  │ palmpay-inc.com │                                                        │
│  │                 │                                                        │
│  │ User-Agent:     │                                                        │
│  │ Amazon CloudFront│                                                       │
│  │                 │                                                        │
│  │ X-Forwarded-For:│                                                        │
│  │ 203.0.113.1     │                                                        │
│  └─────────────────┘                                                        │
│           │                                                                 │
│           v                                                                 │
│  5. 发送到源站                                                               │
│  ┌─────────────────┐                                                        │
│  │   HTTPS连接      │                                                        │
│  │ oms-daily.      │                                                        │
│  │ palmpay-inc.com │                                                        │
│  │     :443        │                                                        │
│  └─────────────────┘                                                        │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                           │
                           v
                ┌─────────────────┐
                │   源站响应       │
                │                 │
                │ 200 OK          │
                │ Content-Type:   │
                │ application/json│
                │                 │
                │ {"users": [...]}│
                └─────────────────┘
                           │
                           v
                ┌─────────────────┐
                │   缓存并返回     │
                │   给用户        │
                └─────────────────┘
```

## 4. Host头处理机制图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Host头处理决策树                                     │
└─────────────────────────────────────────────────────────────────────────────┘

用户请求 Host: oms-daily.palmpaybd.com
                    │
                    v
            ┌───────────────┐
            │ 检查自定义     │      有自定义Host头
            │ Host头配置     │ ──────────────────┐
            └───────┬───────┘                   │
                    │ 无自定义配置               │
                    v                          │
            ┌───────────────┐                  │
            │ 检查Origin     │                  │
            │ Request Policy │                  │
            └───────┬───────┘                  │
                    │                          │
        ┌───────────┼───────────┐              │
        │           │           │              │
        v           v           v              │
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ │
│AllViewerExcept│ │CachingDisabled│ │其他策略    │ │
│HostHeader   │ │             │ │           │ │
│             │ │             │ │           │ │
│排除Host头   │ │不转发Host头 │ │转发Host头  │ │
└─────────────┘ └─────────────┘ └─────────────┘ │
        │           │           │              │
        └───────────┼───────────┘              │
                    │                          │
                    v                          │
            ┌───────────────┐                  │
            │ 使用源站域名   │                  │
            │ oms-daily.    │                  │
            │ palmpay-inc.  │                  │
            │ com           │                  │
            └───────────────┘                  │
                    │                          │
                    └──────────┬───────────────┘
                               │
                               v
                    ┌───────────────┐
                    │ 最终Host头     │
                    │ oms-daily.    │
                    │ palmpay-inc.  │
                    │ com           │
                    └───────────────┘
```

## 5. 缓存键生成与隔离机制图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            缓存键生成机制                                     │
└─────────────────────────────────────────────────────────────────────────────┘

请求1: oms-daily.palmpaybd.com/api/users
                    │
                    v
            ┌───────────────┐
            │ 缓存键组件     │
            │               │
            │ dist:E2N6RIQ  │
            │ domain:oms-   │
            │ daily.palmpay │
            │ bd.com        │
            │ path:/api/    │
            │ users         │
            └───────────────┘
                    │
                    v
            ┌───────────────┐
            │ SHA256哈希     │
            │ a1b2c3d4e5f6  │
            └───────────────┘

请求2: admin-daily.palmpaybd.com/api/users
                    │
                    v
            ┌───────────────┐
            │ 缓存键组件     │
            │               │
            │ dist:E2N6RIQ  │
            │ domain:admin- │
            │ daily.palmpay │
            │ bd.com        │
            │ path:/api/    │
            │ users         │
            └───────────────┘
                    │
                    v
            ┌───────────────┐
            │ SHA256哈希     │
            │ x7y8z9a0b1c2  │
            └───────────────┘

结果: 不同的缓存键 → 缓存隔离
```

## 6. 多源站架构图

```
                    ┌─────────────────┐
                    │   用户请求       │
                    │                 │
                    │ oms-daily.      │
                    │ palmpaybd.com   │
                    └─────────┬───────┘
                              │
                              v
                    ┌─────────────────┐
                    │  CloudFront     │
                    │  边缘节点       │
                    └─────────┬───────┘
                              │
                              │ 域名映射
                              v
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
        v                     v                     v
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   主源站     │     │   备用源站   │     │   灾备源站   │
│             │     │             │     │             │
│ oms-daily.  │     │ oms-backup. │     │ oms-dr.     │
│ palmpay-inc │     │ palmpay-inc │     │ palmpay-inc │
│ .com        │     │ .com        │     │ .com        │
│             │     │             │     │             │
│ 状态: 健康   │     │ 状态: 待机   │     │ 状态: 待机   │
└─────────────┘     └─────────────┘     └─────────────┘
        │                     │                     │
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              v
                    ┌─────────────────┐
                    │   健康检查       │
                    │                 │
                    │ • HTTP检查      │
                    │ • 响应时间      │
                    │ • 错误率        │
                    │ • 可用性        │
                    └─────────────────┘
```

## 7. SSL/TLS处理流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          SSL/TLS握手流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘

用户 → CloudFront
                    │
                    v
            ┌───────────────┐
            │ Client Hello  │
            │               │
            │ SNI: oms-daily│
            │ .palmpaybd.com│
            └───────────────┘
                    │
                    v
            ┌───────────────┐
            │ 证书选择       │
            │               │
            │ 查找匹配证书:  │
            │ *.palmpaybd.  │
            │ com           │
            └───────────────┘
                    │
                    v
            ┌───────────────┐
            │ Server Hello  │
            │               │
            │ 返回证书:     │
            │ *.palmpaybd.  │
            │ com           │
            └───────────────┘

CloudFront → 源站
                    │
                    v
            ┌───────────────┐
            │ Client Hello  │
            │               │
            │ SNI: oms-daily│
            │ .palmpay-inc. │
            │ com           │
            └───────────────┘
                    │
                    v
            ┌───────────────┐
            │ 源站证书验证   │
            │               │
            │ 验证证书:     │
            │ *.palmpay-inc │
            │ .com          │
            └───────────────┘
```

## 8. 配置更新流程图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        配置更新传播流程                                       │
└─────────────────────────────────────────────────────────────────────────────┘

管理员更新配置
        │
        v
┌───────────────┐
│ AWS CLI/API   │
│               │
│ 更新域名映射:  │
│ admin-daily → │
│ oms-daily     │
└───────┬───────┘
        │
        v
┌───────────────┐
│ CloudFront    │
│ 控制平面      │
│               │
│ 验证配置      │
│ 生成新版本    │
└───────┬───────┘
        │
        v
┌───────────────┐
│ 全球分发      │
│               │
│ 推送到400+    │
│ 边缘节点      │
└───────┬───────┘
        │
        v
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│ 边缘节点 1     │     │ 边缘节点 2     │     │ 边缘节点 N     │
│               │     │               │     │               │
│ 更新本地配置   │     │ 更新本地配置   │     │ 更新本地配置   │
│ 刷新缓存      │     │ 刷新缓存      │     │ 刷新缓存      │
└───────────────┘     └───────────────┘     └───────────────┘
        │                       │                       │
        └───────────────────────┼───────────────────────┘
                                │
                                v
                        ┌───────────────┐
                        │ 配置生效       │
                        │               │
                        │ 状态: Deployed│
                        │ 用时: 5-15分钟 │
                        └───────────────┘
```

## 9. 监控指标架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            监控指标体系                                       │
└─────────────────────────────────────────────────────────────────────────────┘

┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   用户层面     │     │   CDN层面      │     │   源站层面     │
│               │     │               │     │               │
│ • 访问延迟     │     │ • 缓存命中率   │     │ • 响应时间     │
│ • 成功率      │     │ • 请求量      │     │ • 错误率      │
│ • DNS解析时间  │     │ • 带宽使用    │     │ • 可用性      │
│ • SSL握手时间  │     │ • 边缘节点    │     │ • 连接数      │
│               │     │   分布        │     │               │
└───────┬───────┘     └───────┬───────┘     └───────┬───────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
                              v
                    ┌─────────────────┐
                    │   告警系统       │
                    │                 │
                    │ • Host头不匹配   │
                    │ • 源站连接失败   │
                    │ • 缓存命中率低   │
                    │ • 响应时间过长   │
                    └─────────────────┘
                              │
                              v
                    ┌─────────────────┐
                    │   自动化响应     │
                    │                 │
                    │ • 故障转移      │
                    │ • 缓存预热      │
                    │ • 流量调度      │
                    │ • 配置回滚      │
                    └─────────────────┘
```

## 10. 故障转移机制图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          故障转移决策流程                                     │
└─────────────────────────────────────────────────────────────────────────────┘

正常状态
┌───────────────┐
│ 用户请求       │
│ oms-daily.    │
│ palmpaybd.com │
└───────┬───────┘
        │
        v
┌───────────────┐
│ CloudFront    │
│ 健康检查      │
└───────┬───────┘
        │
        v
┌───────────────┐     健康     ┌───────────────┐
│ 主源站检查     │ ──────────> │ 正常转发       │
│ oms-daily.    │             │ 到主源站      │
│ palmpay-inc.  │             └───────────────┘
│ com           │
└───────┬───────┘
        │
        │ 不健康
        v
┌───────────────┐
│ 故障检测       │
│               │
│ • 连接超时     │
│ • 5xx错误率高  │
│ • 响应时间长   │
└───────┬───────┘
        │
        v
┌───────────────┐
│ 自动切换       │
│               │
│ 域名映射更新:  │
│ oms-daily.    │
│ palmpaybd.com │
│ ↓             │
│ backup.       │
│ palmpay-inc.  │
│ com           │
└───────┬───────┘
        │
        v
┌───────────────┐
│ 流量转移       │
│ 到备用源站     │
└───────────────┘
```

## 总结

通过以上架构图和流程图，我们可以清晰地看到CDN域名映射的核心技术要点：

### 关键技术机制

1. **域名分离**: 用户访问域名与源站域名完全独立
2. **Host头转换**: CloudFront自动将用户Host头转换为源站Host头
3. **缓存隔离**: 基于CDN域名生成不同缓存键，确保业务隔离
4. **智能路由**: 根据地理位置和健康状态选择最优路径
5. **故障转移**: 自动检测源站健康状态并进行故障切换

### 技术优势

- **业务解耦**: CDN域名与源站域名独立管理
- **安全隐藏**: 真实源站域名对用户不可见
- **灵活扩展**: 支持多源站、负载均衡、故障转移
- **性能优化**: 全球边缘节点就近服务

这种架构设计为现代Web应用提供了高可用、高性能、高安全性的内容分发解决方案。
